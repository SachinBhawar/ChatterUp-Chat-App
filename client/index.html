<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="shortcut icon"
            href="https://res.cloudinary.com/dfkyw4wjn/image/upload/v1721754888/fav_hnrzmq.jpg"
            type="image/x-icon"
        />
        <link rel="stylesheet" href="styles.css" />
        <title>ChatterUp</title>
    </head>
    <body>
        <div id="container">
            <section id="msg-section">
                <div id="brand">
                    <div id="logo-container">
                        <img
                            src="https://res.cloudinary.com/dfkyw4wjn/image/upload/v1721754571/2_ntjomg.jpg"
                            alt=""
                        />
                    </div>
                    <h3 id="app-name">ChatterUp</h3>
                    <div id="dropdown-menu" onclick="togglemenu()">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <ul id="menu-list" class="hide">
                        <li id="profileName" onclick="showProfileUpdateForm()">Profile Image</li>
                        <li onclick="toggleTimeline()">Load Old Messages</li>
                        <li onclick="logout()">
                            <a href="./index.html" style="color: white; text-decoration: none">Logout</a>
                        </li>
                    </ul>
                    <ul id="timeline-list" class="hide">
                        <li onclick="loadMsgs('24hrs')">Last 24 Hrs</li>
                        <li onclick="loadMsgs('oneWeek')">Last week</li>
                        <li onclick="loadMsgs('oneMonth')">Last month</li>
                    </ul>
                </div>

                <div id="msg-box"></div>

                <div id="send-msg">
                    <textarea id="typing-box" rows="1" placeholder="Type message here..."></textarea>
                    <button id="send-msg-btn" onclick="sendMsg()">Send</button>
                </div>

                <div id="dp-update" class="hide">
                    <div id="profile-update-form">
                        <h2>Profile</h2>
                        <div id="dp-img-container"></div>
                        <input id="profilePic" name="profile-image" type="file" hidden />
                        <!-- <label class="btn" for="profilePic" onclick="updateProfile()">Change Dp</label> -->
                        <button class="btn" onclick="hideProfileUpdateForm()">Cancel</button>
                    </div>
                </div>
            </section>

            <section id="user-list">
                <div id="user-list-heading" class="">
                    <h3 id="user-numbers" class="scaleH">Connected Users</h3>
                </div>
                <div id="connected-users-container"></div>
            </section>
        </div>

        <div id="overlay" class="high-z-index">
            <form id="registrationForm">
                <h2>Register</h2>
                <label for="name">Name:</label><br />
                <input type="text" id="name" name="name" /><br />
                <label for="room">Chat Room:</label><br />
                <input type="text" id="room" name="room" /><br />
                <label for="profileImage" id="upload-btn">Upload Profile Image</label><br />
                <input type="file" id="profileImage" name="profileImage" accept="image/*" hidden /><br />
                <button type="submit">Register</button>
            </form>
        </div>

        <!-- scripts -->
        <script src="https://chatterup-chat-app.onrender.com/socket.io/socket.io.js"></script>
        <script>
            const socket = io.connect("https://chatterup-chat-app.onrender.com");

            const overlay = document.getElementById("overlay");
            const menu = document.getElementById("menu-list");
            const timeLine = document.getElementById("timeline-list");
            const typingBox = document.getElementById("typing-box");
            const msgBox = document.getElementById("msg-box");
            const form = document.getElementById("registrationForm");
            const nameInput = document.getElementById("name");
            const roomInput = document.getElementById("room");
            const profileImageInput = document.getElementById("profileImage");
            const connectedUsersContainer = document.getElementById("connected-users-container");
            const profileUpdate = document.getElementById("dp-update");
            let myRoom, myId, myName, myDp, prevSenderId;

            // when document is loaded first appearance is registration form
            // filling registration form is made mandatory & after fillin form emiting 'new user joined' event
            document.addEventListener("DOMContentLoaded", function () {
                form.addEventListener("submit", function (event) {
                    event.preventDefault(); // Prevent the default form submission

                    if (nameInput.value && roomInput.value) {
                        let userName = nameInput.value;
                        let room = roomInput.value;
                        let myDp = null;

                        const file = profileImageInput.files.length ? profileImageInput.files[0] : null; // Get the profile image file
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                myDp = e.target.result;
                                emitUserJoined(userName, room, myDp);
                            };
                            reader.readAsDataURL(file);
                        } else {
                            //if No file available, then use default Dp
                            myDp =
                                "data:image/jpeg;base64,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";
                            emitUserJoined(userName, room, myDp);
                        }

                        // Function to emit the event
                        function emitUserJoined(userName, room, profileImage) {
                            // Show welcome message in our own HTML browser
                            let ele2 = `<div class="user-joined-notification">Welcome, ${userName}! This is room: ${room}</div>`;
                            document.getElementById("msg-box").innerHTML += ele2;
                            socket.emit("new user joined", { userName, room, profileImage });
                            overlay.classList.remove("high-z-index");
                            overlay.classList.add("low-z-index");
                            form.style.display = "none";
                            nameInput.value = "";
                            roomInput.value = "";
                            profileImageInput.value = null;
                        }
                    } else {
                        alert("Please fill out all fields.");
                    }
                });
            });
            //listening to events
            socket.on("alertMsg", (msg) => {
                alert(`${msg}`);
            });

            socket.on("clearAllMsgs", () => {
                document.getElementById("msg-box").innerHTML = "";
            });

            // socket.on("typing", userId);
            socket.on("incomingMsg", (data) => {
                // latency checker functionality
                const receiveTime = Date.now(); // ✅
                const latency = receiveTime - (data.sendTime || receiveTime); // ✅
                console.log(`📤 Outgoing message round-trip latency: ${latency} ms`); // ✅

                if (prevSenderId == data.senderId) {
                    let ele = `<div class="incoming-msg-container">
            <div class="user-dp"></div>
            <div>
              <div class="message-box imcoming-msg">
                <div class="message">${data.message}
                </div>
                <div class="timestamp">
                  <i><small>${data.time}</small></i>
                </div>
              </div>
            </div>
          </div>`;
                    document.getElementById("msg-box").innerHTML += ele;
                } else {
                    prevSenderId = data.senderId;
                    let ele = `<div class="incoming-msg-container">
            <div class="user-dp"><img src="${data.senderDP}" alt="${data.senderName}" /></div>
            <div>
              <div class="user-name">
                <strong>${data.senderName}</strong>
              </div>
              <div class="message-box imcoming-msg">
                <div class="message">${data.message}
                </div>
                <div class="timestamp">
                  <i><small>${data.time}</small></i>
                </div>
              </div>
            </div>
          </div>`;
                    document.getElementById("msg-box").innerHTML += ele;
                }
            });

            socket.on("new user joined", (userData) => {
                let ele0 = `<div class="user-joined-notification">${userData.userName} has joined</div> `;
                document.getElementById("msg-box").innerHTML += ele0;
                socket.emit("refresh-userList", userData.room);
            });

            socket.on("user left", (name) => {
                console.log("user left");
                let ele = `<div class="user-joined-notification">${name} left</div> `;
                document.getElementById("msg-box").innerHTML += ele;
                console.log("logout initiated...");
            });

            socket.on("logout", () => {
                socket.disconnect();
            });

            socket.on("refresh room-userlist", (userList) => {
                console.log("Userlist refresed");
                connectedUsersContainer.innerHTML = "";
                userList.forEach((user) => {
                    let ele = `<div class="connected-user" id="user.id">
            <div class="user-dp"><img src="${user.dp}" alt="${user.name}" /></div>
            <div>
              <div class="user-name">
                <strong>${user.name}</strong>&nbsp;&nbsp;&nbsp;&nbsp;<span
                  ><i><small id="${user.id}" class="sender-status flash hide">typing...</small></i></span
                >
              </div>
          </div>`;
                    connectedUsersContainer.innerHTML += ele;
                    let noOfUsers = userList.length;
                    document.getElementById("user-numbers").innerText = `Connected Users (${noOfUsers})`;
                });
            });

            socket.on("setMyInfo", (data) => {
                myId = data.id;
                myName = data.name;
                myRoom = data.room;
                myDp = data.dp;
                let dpContainer = `<img src = "${myDp}" style="width:100%; height:100%">`;
                document.getElementById("dp-img-container").innerHTML = dpContainer;
                document.getElementById("profileName").innerText = `${myName}'s Profile`;
            });

            socket.on("outgoingMsg", (data) => {
                let ele = `<div class="outgoing-msg-container">
            <div class="message-box outgoing-msg">
              <div class="message">${data.message}</div>
              <div class="timestamp">
                <i><small>${data.time}</small></i>
              </div>
            </div>
          </div>`;

                msgBox.innerHTML += ele;

                typingBox.value = "";
                prevSenderId = myId;
            });

            socket.on("typing", (userId) => {
                document.getElementById(userId).classList.remove("hide");
            });

            socket.on("notTyping", (userId) => {
                document.getElementById(userId).classList.add("hide");
            });
            //emiting events
            // 1 sendMsg : client can type in msg-box and send then emiting the 'sendMsg' event
            function sendMsg() {
                let message = typingBox.value;
                if (message === "") return;

                message = message.replace(/\n/g, "<br />");

                // socket.emit("sendMsg", { message, room: myRoom });
                const sendTime = Date.now(); // ✅ Add this line to capture time before sending
                socket.emit("sendMsg", { message, room: myRoom, sendTime }); // ✅ Send sendTime too
            }

            // 2. load previous msgs as per user requested timespan
            function loadMsgs(timeSpan) {
                timeLine.classList.add("hide");
                socket.emit("load prevMsgs", { timeSpan, room: myRoom });
            }

            // 3. emitting event typing
            typingBox.addEventListener("focus", (event) => {
                event.preventDefault();
                socket.emit("typing", { id: myId, room: myRoom });
            });

            //4. emitting event when user not  focusing on the typingbox
            typingBox.addEventListener("blur", (event) => {
                event.preventDefault();
                socket.emit("notTyping", { id: myId, room: myRoom });
            });
            // frontEnd related functions
            // 1. always scroll down to newly posted message
            function scrollToBottom() {
                msgBox.scrollTop = msgBox.scrollHeight;
            }
            var observer = new MutationObserver(scrollToBottom);
            var config = { childList: true };
            observer.observe(msgBox, config);

            // 2 open menu when clicked on 3 dots and close menu when click happened outside the menu.
            function togglemenu() {
                if (menu.classList.contains("hide")) {
                    menu.classList.remove("hide");
                } else {
                    menu.classList.add("hide");
                }
            }

            document.addEventListener(
                "mousedown",
                function (event) {
                    // Calculate the rectangle of the div
                    var rect = menu.getBoundingClientRect();
                    // Determine if the click was outside the div
                    var isInDiv =
                        event.clientX > rect.left &&
                        event.clientX < rect.right &&
                        event.clientY > rect.top &&
                        event.clientY < rect.bottom;
                    if (!isInDiv) {
                        menu.classList.add("hide");
                    }
                },
                false
            );

            // 3 open loadmessages sub menu and close it when click happened outside the sub-menu.
            function toggleTimeline() {
                if (!menu.classList.contains("hide")) {
                    menu.classList.add("hide");
                }
                timeLine.classList.toggle("hide");
            }

            document.addEventListener(
                "mousedown",
                function (event) {
                    // Calculating the rectangle of the div using getBoundingClientRect method
                    var rect = timeLine.getBoundingClientRect();
                    // Determine if the click was outside the div
                    var isInDiv =
                        event.clientX > rect.left &&
                        event.clientX < rect.right &&
                        event.clientY > rect.top &&
                        event.clientY < rect.bottom;
                    if (!isInDiv) {
                        timeLine.classList.add("hide");
                    }
                },
                false
            );

            // 4 message type textarea if enter happens go to new line and increase rows, max of 3 rows
            document.addEventListener("keydown", function (event) {
                const currentRows = parseInt(msgBox.getAttribute("rows"), 10);

                if (event.key === "Enter") {
                    // Prevent the default Enter key behavior
                    event.preventDefault();
                    sendMsg();
                }

                // Check if Alt + Enter keys were pressed
                if (event.altKey && event.key === "Enter") {
                    // Prevent the default Enter key behavior
                    event.preventDefault();

                    // Increase the number of rows by 1, up to a maximum of 3
                    if (currentRows < 3) {
                        msgBox.setAttribute("rows", String(currentRows + 1));
                    }
                }
            });

            // 5 Update profile, hide profile update form ,show update Profile form
            function updateProfile() {
                const reader = new FileReader();
                const profilePic = document.getElementById("profilePic").files[0];
                console.log(profilePic);
                if (profilePic) {
                    console.log("file is present");
                    reader.onload = (e) => {
                        socket.emit("update-dp", {
                            id: myId,
                            name: myName,
                            room: myRoom,
                            dp: e.target.result,
                        });
                        document.getElementById("profilePic").files[0] = null;
                    };
                } else {
                    hideProfileUpdateForm();
                }
            }

            function hideProfileUpdateForm() {
                profileUpdate.classList.add("hide");
            }

            function showProfileUpdateForm() {
                profileUpdate.classList.remove("hide");
                togglemenu();
            }

            // 6 logout
            function logout() {
                socket.emit("user left", { id: myId, name: myName, room: myRoom });
            }

            // Measure latency (ping)
            function checkLatency() {
                const start = Date.now();
                socket.emit("pingCheck", () => {
                    const latency = Date.now() - start;
                    alert(`Latency: ${latency} ms`);
                });
            }

            // Trigger latency check manually (add a button or run on interval)
            document.addEventListener("keydown", function (e) {
                if (e.key === "L" && e.altKey) {
                    // Alt + L to check latency
                    checkLatency();
                }
            });
        </script>
    </body>
</html>
